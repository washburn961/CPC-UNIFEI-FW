#define GOOSE_MCAST_ADDR "01:0C:CD:01:00:00" // Example multicast MAC address for GOOSE
#define GOOSE_FRAME_SIZE 256 // Adjust based on your GOOSE frame structure

#include "goose_server.h"
#include "lwip/pbuf.h"
#include "lwip/netif.h"
#include "lwip/err.h"
#include "lwip.h"
#include <string.h>

const char packet_bytes [] = {
	0x00,
	0x05,
	0x00,
	0xa5,
	0x00,
	0x00,
	0x00,
	0x00,
	0x61,
	0x81,
	0x9a,
	0x80,
	0x27,
	0x53,
	0x45,
	0x30,
	0x31,
	0x31,
	0x30,
	0x4f,
	0x43,
	0x35,
	0x30,
	0x31,
	0x43,
	0x46,
	0x47,
	0x2f,
	0x4c,
	0x4c,
	0x4e,
	0x30,
	0x24,
	0x47,
	0x4f,
	0x24,
	0x41,
	0x41,
	0x33,
	0x53,
	0x45,
	0x30,
	0x31,
	0x31,
	0x30,
	0x4f,
	0x43,
	0x35,
	0x30,
	0x31,
	0x47,
	0x35,
	0x81,
	0x02,
	0x07,
	0xd0,
	0x82,
	0x24,
	0x53,
	0x45,
	0x30,
	0x31,
	0x31,
	0x30,
	0x4f,
	0x43,
	0x35,
	0x30,
	0x31,
	0x43,
	0x46,
	0x47,
	0x2f,
	0x4c,
	0x4c,
	0x4e,
	0x30,
	0x24,
	0x41,
	0x41,
	0x33,
	0x53,
	0x45,
	0x30,
	0x31,
	0x31,
	0x30,
	0x4f,
	0x43,
	0x35,
	0x30,
	0x31,
	0x47,
	0x35,
	0x83,
	0x1a,
	0x41,
	0x41,
	0x33,
	0x41,
	0x4c,
	0x30,
	0x32,
	0x48,
	0x30,
	0x31,
	0x53,
	0x45,
	0x30,
	0x31,
	0x31,
	0x30,
	0x31,
	0x30,
	0x4f,
	0x43,
	0x35,
	0x30,
	0x31,
	0x47,
	0x30,
	0x35,
	0x84,
	0x08,
	0x66,
	0xec,
	0x9b,
	0xed,
	0x68,
	0x8c,
	0xc0,
	0xbf,
	0x85,
	0x01,
	0x01,
	0x86,
	0x02,
	0x04,
	0x89,
	0x87,
	0x01,
	0x00,
	0x88,
	0x01,
	0x01,
	0x89,
	0x01,
	0x00,
	0x8a,
	0x01,
	0x04,
	0xab,
	0x0c,
	0x83,
	0x01,
	0x00,
	0x83,
	0x01,
	0x00,
	0x83,
	0x01,
	0x00,
	0x83,
	0x01,
	0x00
};


// Function to send GOOSE ping
void send_goose_ping() {
	struct pbuf *p;
    
	// Define the size of the full Ethernet frame
	size_t frame_size = sizeof(packet_bytes) + 14; // 14 bytes for Ethernet header
	uint8_t *ethernet_frame = malloc(frame_size);
    
	if (!ethernet_frame) {
		// Handle memory allocation failure
		return;
	}

	LOCK_TCPIP_CORE();

	// Fill the Ethernet frame
	// Destination MAC address (multicast)
	uint8_t dest_mac[6] = {0x01, 0x0C, 0xCD, 0x01, 0x00, 0x00};
	memcpy(ethernet_frame, dest_mac, 6);

	memcpy(ethernet_frame + 6, gnetif.hwaddr, 6);

	// Ethertype for GOOSE (0x88B8)
	ethernet_frame[12] = 0x88;
	ethernet_frame[13] = 0xB8;

	// Copy the payload
	memcpy(ethernet_frame + 14, packet_bytes, sizeof(packet_bytes));

	// Allocate a pbuf for the Ethernet frame
	p = pbuf_alloc(PBUF_RAW, frame_size, PBUF_POOL);
	if (p == NULL) {
		// Handle allocation failure
		free(ethernet_frame);
		UNLOCK_TCPIP_CORE();
		return;
	}

	// Copy the Ethernet frame into the pbuf
	memcpy(p->payload, ethernet_frame, frame_size);

	// Send the pbuf using the linkoutput function
	if (gnetif.linkoutput(&gnetif, p) != ERR_OK) {
		// Handle send error
	}

	// Free the pbuf and the allocated Ethernet frame
	pbuf_free(p);
	free(ethernet_frame);
    
	UNLOCK_TCPIP_CORE();
}